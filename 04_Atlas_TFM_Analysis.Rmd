---
title: "Transcriptomic Atlas Analysis"
author: "Erise Pérez Pascual"
date: "2025-12-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
```

# Importación de los datos

El conjunto de datos final de este Trabajo Final que consiste en un atlas transcriptómico de scRNA-seq de pacientes con LUAD para estudiar los tumores con mutaciones *driver* en EGFR en comparación con las mutaciones en KRAS y ALK se ha guardado como un objeto Seurat en un archivo rds llamado `final_data_tfm.rds`. Este dataset contiene información para 75513 genes en 61228 células para 27 pacientes, de los cuales 14 presentan mutaciones *driver* en EGFR, 9 en KRAs y 4 en ALK. Se generan subconjuntos para los tres genes *driver* que se van a analizar.

```{r}
# Carga del objeto final
luad_atlas <- readRDS("final_data_tfm.rds")

# Generación de subconjuntos de datos en base al gen driver
egfr_atlas <- subset(luad_atlas, subset = driver_gene == "EGFR")
kras_atlas <- subset(luad_atlas, subset = driver_gene == "KRAS")
alk_atlas <- subset(luad_atlas, subset = driver_gene == "ALK")
```

# QC y corrección del *batch effect* para los datos finales

Se aplica el control de calidad para todo el conjunto de datos para obtener todas aquellas células cuyo número de genes por célula esté entre 200 y 3000, tal y como se especificaba para los datos de referencia.

```{r}
# Aplicación del control de calidad para nFeature_RNA
luad_atlas <- subset(luad_atlas, subset = nFeature_RNA > 200 & nFeature_RNA < 3000)
```

```{r}
# Violin plots para las métricas iniciales de QC
qc1 <- VlnPlot(luad_atlas, "nFeature_RNA", group.by = "Study", raster=F, pt.size=0) + theme_bw() + labs(title="Control de calidad según el número de genes por célula")
qc2 <- VlnPlot(luad_atlas, "Percent_mt", group.by="Study", raster=F, pt.size=0) + theme_bw() + labs(title="Control de calidad según el porcentaje de genes mitocondriales por célula")

(qc1 + qc2) + plot_annotation(title = "Métricas básicas de control de calidad divididas por estudio y genes")

ggsave("atlas_qc.png", plot = get_last_plot(), width = 14)
```

Asimismo, se estudia el efecto *batch* que ha podido producirse tras juntar los datos de referencia (con accesiones GSE) y los de validación. Esto se observa tanto en la representación del PCA como en el UMAP agrupados por el estudio de origen de cada célula. Se observa que las células se distribuyen homogéneamente en los clusters independientemente de su estudio de origen, lo que indica que el efecto *batch* ha sido corregido.

```{r}
# Efecto batch por PCA derivado del lote o estudio de origen de las muestras
batch1  <- DimPlot(luad_atlas, reduction = "pca.ref", dims = c(1, 2), group.by = "Study", raster = FALSE) + theme_bw() + NoLegend() + labs(title="Ausencia de efecto batch por PCA")
batch2 <- DimPlot(luad_atlas, reduction = "umap.ref", dims = c(1, 2), group.by = "Study", raster = FALSE) + theme_bw() + labs(title="Ausencia de efecto batch por UMAP")

(batch1 + batch2) + plot_annotation(title="Ausencia de efecto batch provocado por el origen de las muestras")

ggsave("atlas_batch.png", plot = get_last_plot(), width = 17)
```

Respecto a las proporciones del origen de las células se observa que el dataset de referencia compone un 95.21% del total (vs. 4.79% del dataset de validación). Si se analiza el estudio del que proviene cada célula, el total de los datos de validación viene del estudio de Maynard, A. *et al.*, 2020 (etiquetado como `czbiohub`). La mayor parte de los datos finales proviene del estudio GSE136246 en un 63.95%. 

```{r}
# Proporción según el origen de los datos
prop.table(table(luad_atlas@meta.data$id))
prop.table(table(luad_atlas@meta.data$Study))
```

## Estudio según otras variables confusoras

De igual manera, se puede observar la distribucón de las células en función de otras variables confusoras de los datos que pueden ser de interés para el análisis de los datos y que, asimismo, pueden dar lugar a errores tipo efecto lote. Las variables que se analizarán son el sexo, el estadio tumoral, el gen *driver*, y el tipo de mutación de EGFR para aquellas células cuyo gen *driver* es EGFR. Por lo general, las células se distribuyen homogéneamente independientemente de la variable confusora de agrupación utilizada en cada caso. La principal fuente de heterogeneidad parece ser el gen *driver* mutado en cada caso, aunque la heterogeneidad en las distribuciones parece ser mínima, por lo que no parece haber problemas de efecto *batch*. Cabe destacar que la mayoría de las células con mutaciones en EGFR recogidas pertenecen a tumores en estadio I. Por otra parte, parece haber alguna agrupación propia de tumores en estadio III y de mujeres en el caso de EGFR como gen *driver*. El subconjuntode datos con mutaciones en KRAS parece estar bastante equilibrado respecto a las variables de sexo y estadio tumoral. Finalmente, el subconjunto de datos con mutación en ALK sigue presentando un número de células notablemente menor a los otros dos subconjuntos. 

```{r}
# Control de calidad según otras variables confusoras del estudio
qc3 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Gender', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el sexo")
qc4 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Stage', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el estadio tumoral")
qc5 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'driver_gene', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el gen driver")
qc6 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'EGFR_mutation_type', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el tipo de mutación EGFR")
qc7 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Gender', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el sexo para cada gen driver")
qc8 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Stage', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el estadio para cada gen driver")

(((qc3+qc4)/(qc5+qc6))/qc7/qc8) + plot_annotation(title="Control de calidad según otras variables confusoras del estudio")

ggsave("atlas_confounding.png", plot = get_last_plot(), height=18, width = 16)
```






Se calculan las frecuencias para cada nivel dentro de las variables para poder estudiar la representación de cada grupo confusor. Respecto al estudio de origen, el 67.17% de las muestras provienen del estudio GSE136246 frente al 31.04% de GSE131907 y el 1.79% de GSE153935. Para los dos estudios mayoritarios los porcentajes representan asimismo la representación de las mutaciones KRAS y EGFR en el dataset de referencia, ya que las muestras pertenecen solamente a esos subgrupos de mutación tal y como se observó en gráficos previos. Respecto al estadio tumoral, se observa un 59.01% de muestras en estadio I y un 40.98% de muestras en estadio III. Finalmente, respecto al sexo, el dataset contiene un 40.51% de mujeres y un 57.7% de hombres.

```{r}
# Calculamos las proporciones de las variables confusoras
prop.table(table(luad_reference$Study))
prop.table(table(luad_reference$Stage))
prop.table(table(luad_reference$Gender))
```

Si se observa esta misma representación para los datos de interés principal de este estudio; es decir, las muestras con mutaciones driver en EGFR, se observa lo siguiente: (1) predominan las muestras provenientes del estudio GSE131907 (95.18% vs. 4.82%); (2) hay una mayor representación masculina (75.48% vs. 19.7%); y (3) predominan las mustras con mutaciones de la deleción del exón 19 (39.34% vs. 20.85% de mutaciones en el exon 20 vs. 22.53% de mutaciones L858R del exón 21).
 
```{r}
# Calculamos las proporciones de las variables confusoras solo para EGFR


prop.table(table(egfr_reference$Study))
prop.table(table(egfr_reference$Stage))
prop.table(table(egfr_reference$Gender))
prop.table(table(egfr_reference$EGFR_mutation_type))
```

En el caso de las mutaciones KRAS, se observa que se han manifestado en tumores en estadíos I y III y se distribuyen de forma similar entre los estadios y los géneros, siendo todos ellos del subtipo LUAD. Para las células con mutaciones en KRAS se ha obtenido un dataset más proporcionado. Predominan los tumores en estado III frente a I (60.7% vs. 39.3%), pero apenas hay diferencias de proporción respecto al género (50.74% mujeres vs. 49.25% hombres). Para las células con mutaciones driver en ALK no se calculan las frecunecias porque todas ellas pertenecen, por ahora, a un único paciente. 

```{r}
# Calculamos las proporciones de las variables confusoras para las muestras de KRAS
kras_reference <- subset(luad_reference, subset = driver_gene == "KRAS")
prop.table(table(kras_reference$Stage))
prop.table(table(kras_reference$Gender))
```

