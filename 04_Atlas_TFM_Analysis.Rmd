---
title: "Transcriptomic Atlas Analysis"
author: "Erise Pérez Pascual"
date: "2025-12-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
```

# Importación de los datos

El conjunto de datos final de este Trabajo Final que consiste en un atlas transcriptómico de scRNA-seq de pacientes con LUAD para estudiar los tumores con mutaciones *driver* en EGFR en comparación con las mutaciones en KRAS y ALK se ha guardado como un objeto Seurat en un archivo rds llamado `final_data_tfm.rds`. Este dataset contiene información para 75513 genes en 61228 células para 27 pacientes, de los cuales 14 presentan mutaciones *driver* en EGFR, 9 en KRAs y 4 en ALK. Se generan subconjuntos para los tres genes *driver* que se van a analizar.

```{r}
# Carga del objeto final
luad_atlas <- readRDS("final_data_tfm.rds")

# Generación de subconjuntos de datos en base al gen driver
egfr_atlas <- subset(luad_atlas, subset = driver_gene == "EGFR")
kras_atlas <- subset(luad_atlas, subset = driver_gene == "KRAS")
alk_atlas <- subset(luad_atlas, subset = driver_gene == "ALK")
```

# QC y corrección del *batch effect* para los datos finales

Se aplica el control de calidad para todo el conjunto de datos para obtener todas aquellas células cuyo número de genes por célula esté entre 200 y 3000, tal y como se especificaba para los datos de referencia.

```{r}
# Aplicación del control de calidad para nFeature_RNA
luad_atlas <- subset(luad_atlas, subset = nFeature_RNA > 200 & nFeature_RNA < 3000)
```

```{r}
# Violin plots para las métricas iniciales de QC
qc1 <- VlnPlot(luad_atlas, "nFeature_RNA", group.by = "Study", raster=F, pt.size=0) + theme_bw() + labs(title="Control de calidad según el número de genes por célula")
qc2 <- VlnPlot(luad_atlas, "Percent_mt", group.by="Study", raster=F, pt.size=0) + theme_bw() + labs(title="Control de calidad según el porcentaje de genes mitocondriales por célula")

(qc1 + qc2) + plot_annotation(title = "Métricas básicas de control de calidad divididas por estudio y genes")

ggsave("atlas_qc.png", plot = get_last_plot(), width = 14)
```

Asimismo, se estudia el efecto *batch* que ha podido producirse tras juntar los datos de referencia (con accesiones GSE) y los de validación. Esto se observa tanto en la representación del PCA como en el UMAP agrupados por el estudio de origen de cada célula. Se observa que las células se distribuyen homogéneamente en los clusters independientemente de su estudio de origen, lo que indica que el efecto *batch* ha sido corregido.

```{r}
# Efecto batch por PCA derivado del lote o estudio de origen de las muestras
batch1  <- DimPlot(luad_atlas, reduction = "pca.ref", dims = c(1, 2), group.by = "Study", raster = FALSE) + theme_bw() + NoLegend() + labs(title="Ausencia de efecto batch por PCA")
batch2 <- DimPlot(luad_atlas, reduction = "umap.ref", dims = c(1, 2), group.by = "Study", raster = FALSE) + theme_bw() + labs(title="Ausencia de efecto batch por UMAP")

(batch1 + batch2) + plot_annotation(title="Ausencia de efecto batch provocado por el origen de las muestras")

ggsave("atlas_batch.png", plot = get_last_plot(), width = 17)
```

Respecto a las proporciones del origen de las células se observa que el dataset de referencia compone un 95.21% del total (vs. 4.79% del dataset de validación). Si se analiza el estudio del que proviene cada célula, el total de los datos de validación viene del estudio de Maynard, A. *et al.*, 2020 (etiquetado como `czbiohub`). La mayor parte de los datos finales proviene del estudio GSE136246 en un 63.95%. 

```{r}
# Proporción según el origen de los datos
prop.table(table(luad_atlas@meta.data$id))
prop.table(table(luad_atlas@meta.data$Study))
```

## Estudio según otras variables confusoras

De igual manera, se puede observar la distribucón de las células en función de otras variables confusoras de los datos que pueden ser de interés para el análisis de los datos y que, asimismo, pueden dar lugar a errores tipo efecto lote. Las variables que se analizarán son el sexo, el estadio tumoral, el gen *driver*, y el tipo de mutación de EGFR para aquellas células cuyo gen *driver* es EGFR. Por lo general, las células se distribuyen homogéneamente independientemente de la variable confusora de agrupación utilizada en cada caso. La principal fuente de heterogeneidad parece ser el gen *driver* mutado en cada caso, aunque la heterogeneidad en las distribuciones parece ser mínima, por lo que no parece haber problemas de efecto *batch*. Cabe destacar que la mayoría de las células con mutaciones en EGFR recogidas pertenecen a tumores en estadio I. Por otra parte, parece haber alguna agrupación propia de tumores en estadio III y de mujeres en el caso de EGFR como gen *driver*. El subconjuntode datos con mutaciones en KRAS parece estar bastante equilibrado respecto a las variables de sexo y estadio tumoral. Finalmente, el subconjunto de datos con mutación en ALK sigue presentando un número de células notablemente menor a los otros dos subconjuntos. 

```{r}
# Control de calidad según otras variables confusoras del estudio
qc3 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Gender', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el sexo")
qc4 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Stage', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el estadio tumoral")
qc5 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'driver_gene', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el gen driver")
qc6 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'EGFR_mutation_type', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el tipo de mutación EGFR")
qc7 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Gender', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el sexo para cada gen driver")
qc8 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Stage', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el estadio para cada gen driver")

(((qc3+qc4)/(qc5+qc6))/qc7/qc8) + plot_annotation(title="Control de calidad según otras variables confusoras del estudio")

ggsave("atlas_confounding.png", plot = get_last_plot(), height=18, width = 16)
```

## Proporciones y descripción de los datos

Para el dataset completo, se calculan las frecuencias de cada nivel de las variables de más interés para la descripción de los datos: sexo, estadio tumoral y gen *driver*. En el conjunto de datos prevalecen las células provenientes de hombres en un 55.98% (vs. 42.38% de mujeres), las células de tumoresen estadio I en un 54.79% (vs. 40.8% de estadio III y 4.4% de estadio IV), y las células con mutación *driver* en KRAS en un 62.36% (vs. 34.96% de EGFR y 2.67% de ALK).

```{r}
# Calculamos las proporciones de las principales variables confusoras
prop.table(table(luad_atlas$Gender))
prop.table(table(luad_atlas$Stage))
prop.table(table(luad_atlas$driver_gene))
```

Dado que el principal objetivo de este Trabajo Finales analizar las células con mutaciones *driver* en EGFR, se han generado subconjuntos de datos para cada mutación identificada, de manera que se pueden describir los datos por separado, utilizando los subconjuntos de KRAS y ALK para las comparativas. Así, para los datos de principal interés para LUAD producido por mutacionesen EGFR se observa lo siguiente: (1) el 81.74% de las células analizadas provienen del estudio GSE131907, (2) el 68.89% de las células pertenecen a pacientes varones (frente a 26.97% de mujeres), (3) el 87.7% provienen de tumores en estadio I (vs. 8.31% de estadio III y 4.13% de estadio IV), y (4) la mutación de EGFR que se ha descrito predominantemente en los datos recogidos ha sido la deleción del exón 19 en un 43.27% (frente a la mutación L858R del exón 21 en un 23.99%, mutaciones del exón 20 en un 17.9%, y mutaciones no identificadas en un 14.84%).

```{r}
# Calculamos las proporciones de las variables confusoras solo para EGFR
prop.table(table(egfr_atlas$Study))
prop.table(table(egfr_atlas$Gender))
prop.table(table(egfr_atlas$Stage))
prop.table(table(egfr_atlas$EGFR_mutation_type))
```

En el caso de las mutaciones KRAS, se observa que se han manifestado en tumores en estadíos I, III y IV; y se distribuyen de forma similar entre losdossexos. Predominan las células provenientes de tumores en estado III en un 60.18% (frente a 38.97% de estadio I y 0.84% de estadio Iv), y apenas hay diferencias de proporción respecto al género (51.16% mujeres vs. 48.83% hombres). Para las células provenientes de pacientes con mutación *driver* en ALK predominan las provenientes de muestras de varones en un 53.6% (frente a 39.01% de mujeres y 7.39% no registradas), y en un 92.61% las células de tumores en estadio IV (frente a 7.39% de estadio III).

```{r}
# Calculamos las proporciones de las variables confusoras para las muestras de KRAS
prop.table(table(kras_atlas$Gender))
prop.table(table(kras_atlas$Stage))

# Para ALK
prop.table(table(alk_atlas$Gender))
prop.table(table(alk_atlas$Stage))
```

# Distibución celular

A continuación, se estudia la distribución celular en los niveles 1 y 2 utilizando las anotaciones generadas por el artículo de referencia y utilizando la reducción de `umap.ref`. Al igual que en el artículo de referencia se identifican 9 clústeres para el nivel 1 (resolución de 0.02) y 27 para el nivel 2 (resolución de 0.5). Se puede asimismo dividir las distribuciones únicamente para EGFR dependiendo de la mutación que presente.

```{r}
# Distribución celular de nivel 1 para el dataset de referencia
level1.1 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Cell_Cluster_level1', shuffle = TRUE, raster=FALSE, label = T) +
  labs(title="Distribución celular de nivel 1 para LUAD") +
  theme_bw() + NoLegend()
level1.2 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Cell_Cluster_level1', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = T) +
  labs(title="Distribución celular de nivel 1 para LUAD según el gen driver") +
  theme_bw()

# Distribución celular de nivel 2
level2.1 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Cell_Cluster_level2', shuffle = TRUE, raster=FALSE, label = T, label.size=3) + 
  labs(title="Distribución celular de nivel 2 para LUAD") + 
  theme_bw() + NoLegend()
level2.2 <- DimPlot(luad_atlas, reduction = 'umap.ref', group.by = 'Cell_Cluster_level2', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) +
  labs(title="Distribución celular de nivel 2 para LUAD según el gen driver") +
  theme_bw()

# Distribución en base a las mutaciones de EGFR
level1.egfr <- DimPlot(egfr_atlas, reduction = 'umap.ref', group.by = 'Cell_Cluster_level1', split.by="EGFR_mutation_type", shuffle = TRUE, raster=FALSE, label = F) +
  labs(title="Distribución celular de nivel 1 para LUAD con EGFR driver según su tipo de mutación") +
  theme_bw() + NoLegend()
level2.egfr <- DimPlot(egfr_atlas, reduction = 'umap.ref', group.by = 'Cell_Cluster_level2', split.by="EGFR_mutation_type", shuffle = TRUE, raster=FALSE, label = F) +
  labs(title="Distribución celular de nivel 2 para LUAD con EGFR driver según su tipo de mutación") +
  theme_bw() + NoLegend()

((level1.1+level1.2)/(level2.1+level2.2)/level1.egfr/level2.egfr) + plot_annotation(title="Distribución celular de nivel 1 y 2 para los datos de referencia")

ggsave("atlas_celdist.png", plot = get_last_plot(), height=15, width = 20)
```









