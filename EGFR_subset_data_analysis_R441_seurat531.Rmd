---
title: "EGFR subset generation and analysis"
author: "Erise Pérez Pascual"
date: "2025-12-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, warning = FALSE, message = FALSE}
# Cargamos los paquetes estándar
library(dplyr)
library(Seurat)
library(patchwork)
library(cowplot)
library(ggplot2)
```

# Generación del nuevo dataset

## Carga de datos

```{r}
# Load Large Seurat object of final dataset
final_data <- readRDS("refquery_final.rds")
final_data@meta.data
```

## Procesado del metadata

Se limpia el metadata de manera que para las variables `Stage`, `Subtype` y `Gender` los valores faltantes se computen como un string "NA" que sea leído como el nivel de un factor. Todas las variables se convierten a factores.

```{r}
# Para versiones superiores de RStudio es necesario convertir los NA en variable para que DimPlot no los elimine
final_data$Stage[is.na(final_data$Stage)] <- "NA"
final_data$Subtype[is.na(final_data$Subtype)] <- "NA"
final_data$Gender[is.na(final_data$Gender)] <- "NA"

# Convert to factor if necessary
final_data@meta.data$Patient <- factor(final_data@meta.data$Patient)
final_data@meta.data$Gender <- factor(final_data@meta.data$Gender)
final_data@meta.data$Subtype <- factor(final_data@meta.data$Subtype)
final_data@meta.data$Stage <- factor(final_data@meta.data$Stage)
final_data@meta.data$Study <- factor(final_data@meta.data$Study)
final_data@meta.data$id <- factor(final_data@meta.data$id)
final_data@meta.data$Cell_Cluster_level1 <- 
  factor(final_data@meta.data$Cell_Cluster_level1)
final_data@meta.data$Cell_Cluster_level2 <- 
  factor(final_data@meta.data$Cell_Cluster_level2)
```

## Obtención del subdataset de interés

### Adición de metadata

Se añadirán tres nuevas columnas en el metadata del dataset final: (1) `EGFR_tested` que determine si se han registrado las pruebas de detección de mutaciones en EGFR, (2) `driver_gene` que determine cuál es el gen driver detectado en cada caso (aunque nos interesa especialmente el EGFR, se ha encontrado un caso de ALK y un dataset con información sobre KRAS mutado), y (3) `EGFR_mutation_type` que determine el tipo de mutación de EGFR registrada (WT, ex19del, ex21L858R, ex18, ex20).

```{r}
# Adición de la columna EGFR_tested
final_data_driver <- AddMetaData(final_data, col.name = "EGFR_tested",
                          ifelse(final_data@meta.data$Study=="GSE131907","Yes",
                                 ifelse(final_data@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P5", "Yes",
                                        ifelse(final_data@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P11", "Yes","No"))))

# Adición de la columna driver_gene
final_data_driver <- AddMetaData(final_data_driver, col.name="driver_gene",
                                 ifelse(final_data_driver@meta.data$Study=="GSE131907", "EGFR",
                                        ifelse(final_data@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P5", "EGFR",
                                               ifelse(final_data@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P11", "EGFR",
                                                      ifelse(final_data@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P8", "ALK",
                                                             ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P4", "KRAS",
                                                                    ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P5", "KRAS",
                                                                           ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P6", "KRAS",
                                                                                  ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P7", "KRAS",
                                                                                         ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P8", "KRAS",
                                                                                                ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P9", "KRAS",
                                                                                                       ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P10", "KRAS",
                                                                                                              ifelse(final_data@meta.data$Study=="GSE136246" & final_data@meta.data$Patient=="S3P12", "KRAS", "NA")))))))))))))


# Adición de la columna EGFR_mutation_type
final_data_driver <- AddMetaData(final_data_driver, col.name = "EGFR_mutation_type", 
                                 ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P2", "ex21L858R",
                                        ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P3", "WT",
                                               ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P4", "ex19del", ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P5", "ex20", 
                                                                                                                                                                      ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P6", "WT",
                                                                                                                                                                             ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P7", "WT",
                                                                                                                                                                                    ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P8", "WT",
                                                                                                                                                                                           ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P9", "ex19del",
                                                                                                                                                                                                  ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P10", "WT",
                                                                                                                                                                                                         ifelse(final_data_driver@meta.data$Study=="GSE131907" & final_data_driver@meta.data$Patient=="S4P11", "WT", ifelse(final_data_driver@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P5", "ex19del", 
                                                                                                                                                                                                                                                                                                                            ifelse(final_data@meta.data$Study=="GSE153935" & final_data@meta.data$Patient=="S2P11", "ex21L858R", "NA")))))))))))))
```

En el datset con metadata específica para las mutaciones de EGFR se valora la presencia de mutaciones en el gen EGFR. Se han registrado 6 pacientes a los que se les ha realizado prueba de mutación en EGFR, presentan información en el metadata de los datos de origen y presentan el gen mutado. Entre estos 6 pacientes se cuentan 7233 muestras para la mutación de la deleción en el exón 19 (3 pacientes), 4142 muestras para la mutación L858R del exón 21 (2 pacientes) y 3833 muestras para mutaciones en el exón 20 (1 paciente), así como 4177 muestras con el tipo de mutacióon de EGFR registrada pero no identificada; es decir, "NA" (1 paciente). Además, se han recogido 8 pacientes con mutaciones en KRAS y 1 con mutaciones en ALK.

Se convierten a factores las nuevas variables añadidas.

```{r}
# Convertimos a factor las nuevas variables añadidas
final_data_driver@meta.data$EGFR_tested <- factor(final_data_driver@meta.data$EGFR_tested)
final_data_driver@meta.data$driver_gene <- factor(final_data_driver@meta.data$driver_gene)
final_data_driver@meta.data$EGFR_mutation_type <- factor(final_data_driver@meta.data$EGFR_mutation_type)
```

### Filtro y obtención del nuevo dataset

Con la función `subset()` se filtran las muestras que presentan mutaciones en EGFR y se genera un nuevo objeto Seurat reducido. Para ello se eligen las muestras que presentan la condición `driver_gene == "EGFR" & EGFR_mutation_type != "WT`. Este dataset se guarda como `luad_egfr`.  De la misma manera, se guarda un conjunto de datos que contiene todas aquellas muestras para las que se ha encontrado o registrado una mutación driver con la condición `driver_gene != "NA" & EGFR_mutation_type != "WT"`. Este se guarda como `nsclc_driver`. También se generan datasets `alk_driver` y `kras_driver`.

Estos datasets se guardan con la función `saveRDS()` y se pueden volver a cargar con la función `readRDS()`.

```{r}
# Filtro del nuevo subconjunto de datos
luad_egfr <- subset(final_data_driver, driver_gene == "EGFR" & EGFR_mutation_type != "WT")
#saveRDS(luad_egfr, "luad_egfr.rds")

nsclc_driver <- subset(final_data_driver, driver_gene != "NA" & EGFR_mutation_type != "WT")
#saveRDS(nsclc_driver, "nsclc_driver.rds")

kras_driver <- subset(final_data_driver, driver_gene == "KRAS")
#saveRDS(kras_driver, "kras_driver.rds")

alk_driver <- subset(final_data_driver, driver_gene == "ALK")
#saveRDS(alk_driver, "alk_driver.rds")
```

Para el estudio GSE153935 no hay información sobre el subtipo de NSCLC que sufren los pacientes en el metadata, pero se sabe por el artículo de origen que son pacientes de LUAD, por lo que modificamos esa columna del metadata del subconjunto de datos de interés para que todos ellos pertenezcan a LUAD. Asimismo, se tiene información de que el estadio tumoral de los pacientes pertenecientes a ese estudio es I, al igual que el del otro estudio utilizado. Por tanto, el dataset `nsclc_driver` contiene todas las muestras de LUAD para las que se ha registrado un gen *driver*. Se estandarizaran los metadatos de este dataset y se trabajará con él. Será el dataset de referencia de LUAD para el presente trabajo.

```{r}
# Cargamos el archivo de referencia
luad_reference <- readRDS("nsclc_driver.rds")

# Arreglamos el metadata
luad_reference@meta.data$Subtype <- "LUAD"
luad_reference@meta.data$Stage[luad_reference@meta.data$Study=="GSE153935"&luad_reference@meta.data$driver_gene=="EGFR"] <- "I"
luad_reference@meta.data$Stage[luad_reference@meta.data$Study=="GSE153935"&luad_reference@meta.data$driver_gene=="ALK"] <- "III"
```

# Análisis de los datos de interés: LUAD con mutación en EGFR; y paralelamente los datos con mutaciones en KRAS y ALK

Como se ha mencionado anteriormente, el subconjunto de datos de interés está compuesto por 7 pacientes con LUAD para los que se ha identificado que la mutación driver ha sido en el gen EGFR. Seis de ellos presentan asimismo información específica sobre el tipo de mutación que ha sufrido el gen, mientras que para el paciente 'S4P1' es desconocida ("NA"). Como el subconjunto de datos contiene también las mutaciones de KRAs y ALK, que se computan como "NA" para la variable `EGFR_mutation_type`, se cambia el valor del paciente 'S4P1' y se computa como `not identified`.

```{r}
# Cambiamos el nombre de la mutación EGFR no identificada
luad_reference@meta.data$EGFR_mutation_type[luad_reference@meta.data$Patient=="S4P1"] <- "not identified"

table(luad_reference$Patient, luad_reference$EGFR_mutation_type)
```

## QC y batch effect para el subconjunto de datos

Se espera que el QC esté correcto ya que los datos han sido corregidos y limpiados anteriormente, antes de hacer el subconjunto de datos. Se realizan de nuevo los violin plots de las métricas de QC (porcentaje de genes mitocondriales `Percent_mt` y el número de genes detectados en cada célula `nFeature_RNA`), divididos por estudio. Se observa que se incluyen en el subconjunto de datos lás céluloas con `nFeature_RNA` entre 200 y 3000, y porcentaje de genes mitocondriales menores a 20%. 

```{r}
# Violin plots para las métricas iniciales de QC
qc1 <- VlnPlot(luad_reference, "nFeature_RNA", group.by = "Study", split.by = "driver_gene", raster=F, pt.size=0) + theme_bw() + labs(title="Control de calidad según el número de genes por célula")
qc2 <- VlnPlot(luad_reference, "Percent_mt", group.by="Study", split.by="driver_gene", raster=F, pt.size=0) + theme_bw() + labs(title="Control de calidad según el porcentaje de genes mitocondriales por célula")

(qc1 + qc2) + plot_annotation(title = "Métricas básicas de control de calidad divididas por estudio y genes")

ggsave("luad_ref_qc.png", plot = get_last_plot(), width = 14)
```

Asimismo, se observa que el efecto batch ha sido corregido. Las células de cada estudio se distribuyen homogéneamente y no dependiendo de su estudio. Aunque el estudio GSE131907 sea predominante, las células pertenecientes a todos los estudios se distribuyen de forma homogénea.

```{r}
# Efecto batch por PCA derivado del lote o estudio de origen de las muestras
batch1  <- DimPlot(luad_reference, reduction = "pca", dims = c(1, 2), group.by = "Study", raster = FALSE) + theme_bw() + labs(title="Ausencia de efecto batch por PCA")
batch2 <- DimPlot(luad_reference, reduction = "umap.ref", dims = c(1, 2), group.by = "Study", raster = FALSE) + theme_bw() + labs(title="Ausencia de efecto batch por UMAP")

(batch1 + batch2) + plot_annotation(title="Ausencia de efecto batch provocado por el origen de las muestras")

ggsave("luad_ref_batch.png", plot = get_last_plot(), width = 20)
```

## Distribución de los datos según otras variables del metadata

Adicionalmente, se puede observar que no se dan efectos tipo batch relacionados con ninguna de las otras variables del metadata, ya que se da una distribución similar de los tipos celulares en todos los clusters independientemente de la variable de agrupamiento. Se observa que la distribución celular es bastante homogénea en todos los agrupamientos independientemente de la variable confusora. Es reseñable que,en base al sexo, el subconjunto para la mutación EGFR está bastante desequilibrada debido a que se tienen más muestras de mujeres que de hombres. Por otra parte, parece haber una subpoblación celular diferencial especialmente marcada en mujeres con mutaciones driver en KRAS. Respecto al estadio tumoral, las muestras recogidas para EGFR pertenecen todas ellas a tumores en estadio I, el paciente de ALK pertenece al estadio III, y para KRAS hay tumores en ambos estadios. Cabe destacar también que la principal diferenciación detectadaa simple vista en este primer paso del análisis se debe al tipo de mutación registrado, lo cual es esperable.

```{r}
# Control de calidad según otras variables confusoras del estudio
qc3 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Gender', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celularsegún el sexo")
qc4 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Stage', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el estadio tumoral")
qc5 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'driver_gene', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el gen driver")
qc6 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'EGFR_mutation_type', shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el tipo de mutación EGFR")
qc7 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Gender', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el sexo para cada gen driver")
qc8 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Stage', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) + theme_bw() + labs(title="Distribución celular según el estadio para cada gen driver")

(((qc3+qc4)/(qc5+qc6))/qc7/qc8) + plot_annotation(title="Control de calidad según otras variables confusoras del estudio")

ggsave("luad_ref_confounding.png", plot = get_last_plot(), height=18, width = 16)
```

Se calculan las frecuencias para cada nivel dentro de las variables para poder estudiar la representación de cada grupo confusor. Respecto al estudio de origen, el 67.17% de las muestras provienen del estudio GSE136246 frente al 31.04% de GSE131907 y el 1.79% de GSE153935. Para los dos estudios mayoritarios los porcentajes representan asimismo la representación de las mutaciones KRAS y EGFR en el dataset de referencia, ya que las muestras pertenecen solamente a esos subgrupos de mutación tal y como se observó en gráficos previos. Respecto al estadio tumoral, se observa un 59.01% de muestras en estadio I y un 40.98% de muestras en estadio III. Finalmente, respecto al sexo, el dataset contiene un 40.51% de mujeres y un 57.7% de hombres.

```{r}
# Calculamos las proporciones de las variables confusoras
prop.table(table(luad_reference$Study))
prop.table(table(luad_reference$Stage))
prop.table(table(luad_reference$Gender))
```

Si se observa esta misma representación para los datos de interés principal de este estudio; es decir, las muestras con mutaciones driver en EGFR, se observa lo siguiente: (1) predominan las muestras provenientes del estudio GSE131907 (95.18% vs. 4.82%); (2) hay una mayor representación masculina (75.48% vs. 19.7%); y (3) predominan las mustras con mutaciones de la deleción del exón 19 (39.34% vs. 20.85% de mutaciones en el exon 20 vs. 22.53% de mutaciones L858R del exón 21).
 
```{r}
# Calculamos las proporciones de las variables confusoras solo para EGFR
egfr_reference <- subset(luad_reference, subset = driver_gene == "EGFR")
prop.table(table(egfr_reference$Study))
prop.table(table(egfr_reference$Stage))
prop.table(table(egfr_reference$Gender))
prop.table(table(egfr_reference$EGFR_mutation_type))
```

En el caso de las mutaciones KRAS, se observa que se han manifestado en tumores en estadíos I y III y se distribuyen de forma similar entre los estadios y los géneros, siendo todos ellos del subtipo LUAD. Para las células con mutaciones en KRAS se ha obtenido un dataset más proporcionado. Predominan los tumores en estado III frente a I (60.7% vs. 39.3%), pero apenas hay diferencias de proporción respecto al género (50.74% mujeres vs. 49.25% hombres). Para las células con mutaciones driver en ALK no se calculan las frecunecias porque todas ellas pertenecen, por ahora, a un único paciente. 

```{r}
# Calculamos las proporciones de las variables confusoras para las muestras de KRAS
kras_reference <- subset(luad_reference, subset = driver_gene == "KRAS")
prop.table(table(kras_reference$Stage))
prop.table(table(kras_reference$Gender))
```

## Distribución celular

A continuación, se estudia la distribución celular en los niveles 1 y 2 utilizando las anotaciones generadas por el artículo de referencia y utilizando la reducción de `umap.ref`. Se espera que se encuentren en todos los subconjuntos con buena representación celular (EGFR y KRAS / ALK si tuviera más células) los mismos clusters encontrados en el estudio para NSCLC en general (9 clusters para el nivel 1 y 27 clusters para el nivel 2). Se puede asimismo dividir las distribuciones únicamente para EGFR dependiendo de la mutación que presente.

```{r}
# Distribución celular de nivel 1 para el dataset de referencia
level1.1 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Cell_Cluster_level1', shuffle = TRUE, raster=FALSE, label = T) +
  labs(title="Distribución celular de nivel 1 para LUAD") +
  theme_bw() + NoLegend()
level1.2 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Cell_Cluster_level1', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = T) +
  labs(title="Distribución celular de nivel 1 para LUAD según el gen driver") +
  theme_bw()

# Distribución celular de nivel 2
level2.1 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Cell_Cluster_level2', shuffle = TRUE, raster=FALSE, label = F) + 
  labs(title="Distribución celular de nivel 2 para LUAD") + 
  theme_bw() + NoLegend()
level2.2 <- DimPlot(luad_reference, reduction = 'umap.ref', group.by = 'Cell_Cluster_level2', split.by="driver_gene", shuffle = TRUE, raster=FALSE, label = F) +
  labs(title="Distribución celular de nivel 2 para LUAD según el gen driver") +
  theme_bw()

# Distribución en base a las mutaciones de EGFR
level1.egfr <- DimPlot(egfr_reference, reduction = 'umap.ref', group.by = 'Cell_Cluster_level1', split.by="EGFR_mutation_type", shuffle = TRUE, raster=FALSE, label = F) +
  labs(title="Distribución celular de nivel 1 para LUAD con EGFR driver según su tipo de mutación") +
  theme_bw() + NoLegend()
level2.egfr <- DimPlot(egfr_reference, reduction = 'umap.ref', group.by = 'Cell_Cluster_level2', split.by="EGFR_mutation_type", shuffle = TRUE, raster=FALSE, label = F) +
  labs(title="Distribución celular de nivel 2 para LUAD con EGFR driver según su tipo de mutación") +
  theme_bw() + NoLegend()

((level1.1+level1.2)/(level2.1+level2.2)/level1.egfr/level2.egfr) + plot_annotation(title="Distribución celular de nivel 1 y 2 para los datos de referencia")

ggsave("luad_ref_celdist.png", plot = get_last_plot(), height=13, width = 20)
```

Se puede calcular la proporción celular total para el conjunto de datos completo. En este caso, se observa que el tipo celular principal más presente en elLUAD son las células T con un 40.85%, seguidas de las células mieloides con un 24.75% y las células B con un 15.31%. El resto de los tipos celulares de nivel 1 se encuentran en una proporción menor al 10%. Por tanto, las principales células presentes en el microambiente tumoral de los pacientes de LUAD son células inmunitarias. Para el nivel 2, las subpoblaciones más representadas en más de un 10% del total son *Naive T* (21.37%), *Mature naive B* (14.78%), CD8+ Tem (10.87%), y Mac asociados a lípidos (10.22%).

```{r}
# Proporciones de tipos celulares en los niveles 1 y 2
sort(prop.table(table(luad_reference$Cell_Cluster_level1)), decreasing=T)
sort(prop.table(table(luad_reference$Cell_Cluster_level2)), decreasing = T)
```

Clasificando las células en base a su mutación driver se observa lo siguiente. Tanto para EGFR como para KRAS, los tres tipos celulars de nivel 1 con más representación (más del 10%) son las mismas que para la población general, aunque se observan cambios en los porcentajes cuya significancia se calculará en el dataset final. Para las mutaciones de EGFR se observa más proporción de células T, mientras que para las muestras con mutaciones en KRAs se observa más alta proporción de células mieloides y células B.

```{r}
# Proporción celular para EGFR
sort(prop.table(table(egfr_reference$Cell_Cluster_level1)), decreasing = T)
sort(prop.table(table(egfr_reference$Cell_Cluster_level2)), decreasing = T)

# Proporción celular para KRAS
sort(prop.table(table(kras_reference$Cell_Cluster_level1)), decreasing = T)
sort(prop.table(table(kras_reference$Cell_Cluster_level2)), decreasing = T)
```

Se representan las proporciones de los tipos celulares de nivel 1 de forma más gráfica utilizando un barplot agrupado para las frecuencias de cada tipo celulas según el sexo, el gen driver o el tipo de mutación de EGFR. Esto nos permite comparar de manera más visual los tipos celulares presentes en cada muestra y sus proporciones.

```{r}
# Diagrama de barras agrupado para las proporciones de células de nivel 1 según género, tipo de gen driver y tipo de mutación de EGFR

# Según gen driver
driver_dist <- luad_reference@meta.data %>%
  count(driver_gene, Cell_Cluster_level1)
bar1 <- ggplot(driver_dist, aes(x=driver_gene, y=n/sum(n), fill=Cell_Cluster_level1)) +
  geom_bar(position="fill", stat="identity") + theme(axis.text.x=element_text(angle=45, hjust=1)) +
  theme_bw() + NoLegend()

# Según Gender
gender_dist <- egfr_reference@meta.data %>%
  count(Gender, Cell_Cluster_level1)
bar2 <- ggplot(gender_dist, aes(x=Gender, y=n/sum(n), fill=Cell_Cluster_level1)) +
  geom_bar(position="fill", stat="identity") + theme_bw() + NoLegend()

# Según el tipo de mutación de EGFR
egfr_dist <- egfr_reference@meta.data %>%
  count(EGFR_mutation_type, Cell_Cluster_level1)
bar3 <- ggplot(egfr_dist, aes(x=EGFR_mutation_type, y=n/sum(n), fill=Cell_Cluster_level1)) +
  geom_bar(position="fill", stat="identity") + theme(axis.text.x=element_text(angle=45, hjust=1)) + theme_bw()

bar1 + bar2 + bar3 + plot_annotation(title="Distribución de los tipos celulares de nivel 1")

ggsave("luad_ref_baroplot.png", plot = get_last_plot(), height=10, width = 18)
```

## Visualización de los genes marcadores usados para la anotación de los clústeres

Como se ha comentado, en el agrupamiento de nivel 1 se encuentran 9 clústeres y en el agrupamiento de nivel 2, 27. Los clústeres se identifican y anotan gracias a la expresión de genes diferencialmente expresados, los cuales se pueden observar mediante `VlnPlot()` o `FeaturePlot()`. Los genes utilizados para la anotación de los clústeres se extraen del artículo de referencia y se visualizan.

```{r}
# Se ordenan y se definen las identidades de las anotaciones de nivel 1
luad_reference@meta.data$Cell_Cluster_level1 <- 
  factor(luad_reference$Cell_Cluster_level1, levels=c("T", "B", "Plasma",
                                                  "Myeloid", "Mast",
                                                  "Endothelial", 
                                                  "Cancer",
                                                  "Ciliated",
                                                  "Fibroblasts"))

Idents(luad_reference) <- luad_reference$Cell_Cluster_level1

# Lista de genes para las agrupaciones de nivel 1
genes_level1 <- c("CD3D", "TRAC", "TRBC2", "MS4A1", "LY9", "BANK1", "MZB1", "JCHAIN", "IGHG3", "LYZ", "AIF1", "C1QA", "TPSAB1", "CPA3", "GATA2", "VWF", "EPAS1", "CLDN5", "KRT17", "AKR1C1", "KRT6A", "CAPS", "TPPP3", "C20orf85", "COL1A1", "COL1A2", "DCN")
genes_level1 <- genes_level1[genes_level1 %in% rownames(luad_reference)]

VlnPlot(luad_reference, features = genes_level1, raster = F, combine=T, pt.size=0, stack=T, flip=T, fill.by = "ident") +
  theme(
    axis.text.x = element_text(size=8,angle=45,hjust=1),
    axis.text.y = element_blank(),
    strip.text = element_text(size=8)) + NoLegend() + 
  labs(title="Marcadores celulares específicos utilizados para la identificación de los tipos celulares de nivel 1")

ggsave("luad_ref_markers1_vlnplot.png", plot = get_last_plot(), height=14, width = 19)
```

Se procede de la misma manera para visualizar la expresión de los genes marcadores para las anotaciones de nivel 2.

```{r, include=TRUE, eval=FALSE}
# se ordenan y definen las identidades de nivel 2
luad_reference@meta.data$Cell_Cluster_level2 <-
  factor(luad_reference$Cell_Cluster_level2, 
                             levels= c("Proliferating T/NK", "NK",
                                       "Naive T","CD8+ Tem", 
                                       "CD4+ Treg", "Mature naive B",
                                       "Plasma","pDCs",
                                       "cDC2/moDCs", "Mast",
                                       "Monocytes","Low quality Mac",
                                       "Lipid-associated Mac", 
                                       "Alveolar Mac",
                                       "Proliferating Mac",
                                       "Neutrophils", "CDKN2A Cancer",
                                       "SOX2 Cancer",
                                       "CXCL1 Cancer", 
                                       "LAMC2 Cancer",
                                       "Proliferating Cancer",
                                       "Pathological Alveolar", 
                                       "Alveolar","Ciliated",
                                       "CAF","SMC", "Endothelial"))
Idents(luad_reference) <- luad_reference$Cell_Cluster_level2

# Se define lalista de marcadores
genes_level2<- c("CD3G","CDCA5","FGFBP2","TRDC","CCR7","IL7R","GZMK","CD8A","FOXP3","IL2RA","MS4A1","BANK1","IGHG2","MZB1","LILRA4","IL3RA","CD1C","CD1A","MS4A2","GATA2","FCN1","CD300E","APOE","C1QA","PLA2G7","ABCA1","FABP4","MARCO","PCLAF","CSF1R","CXCR2","AQP9","CDKN2A","CXCL14","SOX2","UCHL1","SPRR1B","CXCL1","LAMC2","TFF1","ECT2","EGFR","SPINK1","MET","SFTPD","ABCA3","FAM183A","CAPS","MMP2","CTHRC1","RGS5","PPP1R14A","CLDN5","VCF")
genes_level2 <- genes_level2[genes_level2 %in% rownames(luad_reference)]

VlnPlot(luad_reference, features = genes_level2, raster = F, combine=T, pt.size=0, stack=T, flip=T, fill.by = "ident") +
  theme(
    axis.text.x = element_text(size=8,angle=45,hjust=1),
    axis.text.y = element_blank(),
    strip.text = element_text(size=8)) + NoLegend() + 
  labs(title="Marcadores celulares específicos utilizados para la identificación de los tipos celulares de nivel 2")

ggsave("luad_ref_markers2_vlnplot.png", plot = get_last_plot(), height=14, width = 19)
```

Por otra parte, con los `FeaturePlot()` se puede observar en qué clúster se da la expresión de cada marcador, lo cual ayuda en la anotaciones.

```{r}
# FeaturePlot para marcadores de nivel 1
FeaturePlot(luad_reference, reduction="umap.ref", features = genes_level1, raster=F)

ggsave("luad_ref_featureplot1.png", plot = get_last_plot(), height=20, width=12)

# FeaturePlot para marcadores de nivel 2
FeaturePlot(luad_reference, reduction="umap.ref", features = genes_level2[1:26], raster=F)
ggsave("luad_ref_featureplot2.1.png", plot = get_last_plot(), height=20, width=12)

FeaturePlot(luad_reference, reduction="umap.ref", features = genes_level2[26:53], raster=F)
ggsave("luad_ref_featureplot2.2.png", plot = get_last_plot(), height=20, width=12)
```


